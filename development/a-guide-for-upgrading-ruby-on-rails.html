<!DOCTYPE html>
<html lang="zh"><head><title>Ruby on Rails 升级指南 | Jim.h’ Blog</title><meta name="generator" content="Jekyll v3.9.3" /><meta property="og:title" content="Ruby on Rails 升级指南" /><meta name="author" content="Jim Huang" /><meta property="og:locale" content="zh_CN, en_US" /><meta name="description" content="本篇讲解升级至新版 Rails 所需的步骤。同时也提供各版本的升级指导。 1. 一般建议 升级前先想好为何要升级：需要新功能？旧代码越来越难维护？有多少时间？有能力解决升级的兼容问题吗？等等。 1.1 测试覆盖度 最好的方式来确保应用程序升级后仍然正常工作，便是有全面的测试覆盖度。若没有撰写测试，将会花上许多时间，来处理升级带来的新变化。在升级前，先确保测试覆盖得够广吧！ 1.2 Ruby 版本 Rails 通常与最新的 Ruby 一起前进： Rails 3 以上需要高于 1.8.7 版本的 Ruby。 Rails 3.2.x 是最后支持 Ruby 1.8.7 的版本。 Rails 4 推荐使用 Ruby 2.0。 小贴士：Ruby 1.8.7 p248 与 p249 有 marshaling bugs，会让 Rails 无预警的 crash。REE 从 1.8.7-2010.02 之后的版本已经修正了这个问题。关于 Ruby 1.9，不要使用 1.9.1，有 segfaults 的问题，1.9 就用 1.9.3 吧。 定案： 强烈推荐使用 Ruby 2.0.0-p247 Ruby 1.9.3-p448 Ruby 1.8.7 退出历史舞台 1.3 HTTP PATCH 这里的路由作动词解。 Rails 4 更新操作的主要 HTTP 动词换成了 PATCH。当你在 config/routes.rb 以 RESTful 形式宣告某个 resource 时，PUT 仍会路由到 update action，只是多了个 PATCH，同样路由到 update action。 resources :users* # erb &lt;%= form_for @user do |f| %&gt; class UsersController &lt; ApplicationController def update # 代码不用改；偏好使用 PATCH，PUT 仍然可用。 end end 但是，当使用 form_for 来更新自定路由（使用 PUT HTTP 动词）的 resource 时， resources :users, do put :update_name, on: :member end &lt;%= form_for [ :update_name, @user ] do |f| %&gt; class UsersController &lt; ApplicationController def update_name # 要修改代码；form_for 会试著使用不存在的 PATCH 路由。 end end 若不是公有的 API，并且你有决定权换 HTTP 动词，那就把它从 PUT 改成 PATCH 吧。 在 Rails 4 对 /users/:id 做 PUT 请求，会被导向 update。所以要是 API 接受 PUT 请求，那没问题。Router 同时也会将来自 /users/:id 的 PATCH 请求导向 update action。 resources :users do patch :update_name, on: :member end 若此 action 正被公有的 API 使用，且你无权更改 HTTP 动词时，可更新 form，使用 PUT 动词： &lt;%= form_for [ :update_name, @user ], method: :put do |f| %&gt; 至于为什么要改成 PATCH，参考这篇文章。 1.3.1 关于 media types 的说明 RFC 5789 的勘误表示某些 media type 要用 PATCH 动词才正确，比如 JSON Patch。 Rails 没有原生支持 JSON Patch，但添加 JSON Patch 的支持非常简单： # 在 controller def update respond_to do |format| format.json do # perform a partial update @post.update params[:post] end format.json_patch do # perform sophisticated change end end end 在 config/initializers/json_patch.rb: Mime::Type.register &#39;application/json-patch+json&#39;, :json_patch 由于 JSON Patch 最近才有 RFC，仍未有好的 Ruby 函式库出现。Aaron Patterson 的 hana 是一个实作 JSON Patch 的 gem，但仍未完整支援 Spec 里所有最近更新的内容。 2. 从 Rails 3.2 升级到 Rails 4.0 注意：本小节仍在完善当中。 若你是 3.2 以前的版本，先升到 3.2 再试著升到 Rails 4.0。 以下是针对从 Rails 3.2 升级至 Rails 4.0 的说明。 2.1 Gemfile Rails 4.0 移除了 Gemfile 里的 assets group。升级至 4.0 时要移除这个 group，同时需要更新 config/application.rb： # Require the gems listed in Gemfile, including any gems # you&#39;ve limited to :test, :development, or :production. Bundler.require(:default, Rails.env) 2.2 vendor/plugins Rails 4.0 不再支援从 vendor/plugins 载入 plugins。 必须 将任何 plugins 包成 Gems ，再加入至 Gemfile。若你不想包成 Gem，则可将 plugin 移到 lib/my_plugin/*，并使用适当的 initializer：config/initializer/my_plugin.rb。 2.3 Active Record Rails 4.0 移除了 Active Record 的 identity map，因为这会导致某些关联的不一致性。也就是说 config.active_record.identity_map ，这个设置不再有作用。 Collection association 里的 delete 方法现在可接受 Fixnum 或 String 参数作为 record id，跟 destroy 类似。先前会抛出 ActiveRecord::AssociationTypeMismatch。从 Rails 4.0 起，delete 会自动在删除前，找到匹配的 id。 Rails 4.0 当 column 或 table 重命名时，相关的 index 也会重新命名。也就是不用写 rename index 的 migration 了。 Rails 4.0 将 serialized_attributes 及 attr_readonly 改为类别方法。即先前 self.serialized_attributes 改为 self.class.serialized_attributes。 Rails 4.0 引入 Strong Parameters 机制，故移除了 attr_accessible 与 attr_protected （抽离成 Protected Attributes gem）。 若你没有使用 Protected Attributes，可以把任何与 whitelist_attributes 或 mass_assignment_sanitizer 有关的选项移除。 Rails 4.0 要求 scope 必须是可调用的对象（Proc 或 lambda）。 scope :active, where(active: true) # 变成 scope :active, -&gt; { where active: true } Rails 4.0 弃用了 ActiveRecord::Fixtures，请使用 ActiveRecord::FixtureSet。 Rails 4.0 弃用了 ActiveRecord::TestCase，请使用 ActiveSupport::TestCase。 Rails 4.0 弃用了旧式，以 hash 为基础的 Finder API。这表示新的 Finder API 不再接受 “finder options”。 弃用了除了 find_by_...、find_by_...! 这两个以外的动态 Finder 方法，以下是如何修正： Rails 3 Rails 4 find_all_by_... 改成 where(...) find_last_by_... 改成 where(...).last scoped_by_... 改成 where(...) find_or_initialize_by_... 改成 find_or_initialize_by(...) find_or_create_by_... 改成 find_or_create_by(...) 注意！ where(...) 返回 relation，而不像旧式 Finder 方法会返回阵列，需要返回阵列请用 to_a。 注意！这些对应的方法，不会与先前的 Finder 方法，生成出相同的 SQL 语句。 要重新启用旧式的 Finder 方法，可以使用 activerecord-deprecated_finders gem。 2.4 Active Resource Rails 4.0 将 Active Resource 抽成独立的 Gem。若你仍需要此功能，将 Active Resource gem 加到 Gemfile。 2.5 Active Model Rails 4.0 更改了 ActiveModel::Validations::ConfirmationValidator 错误附加的方式。以前 confirmation 验证错误发生时，错误会加到 attribute 上，现在则会附加到 :#{attribute}_confirmation。 Rails 4.0 将 ActiveModel::Serializers::JSON.include_root_in_json 的缺省值改为 false，现在 Active Model Serializers 与 Active Record 对象缺省有著相同的行为。这表示你可以移除或注解掉这一行： # config/initializers/wrap_parameters.rb # Disable root element in JSON by default. # ActiveSupport.on_load(:active_record) do # self.include_root_in_json = false # end 2.6 Action Pack Rails 4.0 引入了 ActiveSupport::KeyGenerator，用来生成及检查已签署的 cookie。请在 config/initializers/secret_token.rb 加入新的 secret_key_base： # config/initializers/secret_token.rb Myapp::Application.config.secret_token = &#39;existing secret token&#39; Myapp::Application.config.secret_key_base = &#39;new secret key base&#39; 请注意！要等到使用者都使用你的 Rails 4.x app，并确保你不会降级到 Rails 3.x，才设置 secret_key_base。因为 cookie 签署的算法并不向下相容。忽略 deprecation warning 使用 secret_token 也是没问题的，只要你知道你自己在做什么就好。 如果有外部应用程序或是 JavaScript，需要能够读 Rails app 签署的 session cookies，在你还没有解决这些问题之前，不要设置 secret_key_base。 有设置 secret_key_base 的话，Rails 4.0 会加密以 cookie-based session 的内容。Rails 3.x 有签署，但未加密。签署的 cookie 是安全的，因为他们是经由你的 app 生成与签署。然而 cookie 的内容仍可被使用者看到，因此加密内容排除了此风险，且没有降低多少的效能。请阅读 Pull Request #9978 来了解更多有关 session cookie 加密的细节。 Rails 4.0 移除了 ActionController::Base.asset_path 选项。请使用 Assets Pipeline。 Rails 4.0 弃用了 ActionController::Base.page_cache_extension 选项。请使用 ActionController::Base.default_static_extension 来取代。 Rails 4.0 从 Action Pack 移除了 Action 与 Page 的 Cache。若要使用 caches_action、caches_pages 请加入 actionpack-action_caching gem。 Rails 4.0 移除了 XML 参数解析器。若要使用请加入 actionpack-xml_parser。 Rails 4.0 更改了缺省的 memcached 用户端，从 memcache-client 换成了 dalli，升级只需加入 gem &#39;dalli&#39; 至 Gemfile。 Rails 4.0 弃用了 Controller 的 dom_id 与 dom_class 方法（View 依然能用）。要用的话请在 Controller include ActionView::RecordIdentifier。 Rails 4.0 弃用了 link_to 的 :confirm 选项，应改写为 data: { confirm: &#39;Are you sure?&#39; }，link_to_if、link_to_unless 同样受影响。 Rails 4.0 修改了 assert_generates、assert_recognizes 以及 assert_routing 的工作方式。这些 assertions 会抛出 Assertion 而不是 ActionController::RoutingError` 错误。 在 Rails 4.0，如果定义了重复名称的路由时，会抛出 ArgumentError。请见下面两例（重复的 example_path）： get &#39;one&#39; =&gt; &#39;test#example&#39;, as: :example get &#39;two&#39; =&gt; &#39;test#example&#39;, as: :example resources :examples get &#39;clashing/:id&#39; =&gt; &#39;test#example&#39;, as: :example 第一个例子可直接换名字来解决。第二个例子可使用 resources 方法提供的 only 与 except 选项来限制生成出的路由，详见 Routing Guide Rails 4.0 更改了 route 有 unicode 字符的生成方式。现在 route 里可直接使用 unicode 字符，先前需要 escape 的作法不再需要了： get Rack::Utils.escape(&#39;こんにちは&#39;), controller: &#39;welcome&#39;, action: &#39;index&#39; 改为 get &#39;こんにちは&#39;, controller: &#39;welcome&#39;, action: &#39;index&#39; Rails 4.0 要求使用 match 的 route 必须指定 HTTP 动词: # Rails 3.x match &quot;/&quot; =&gt; &quot;root#index&quot; # 改成 match &quot;/&quot; =&gt; &quot;root#index&quot;, via: :get # 或 get &quot;/&quot; =&gt; &quot;root#index&quot; Rails 4.0 移除了 ActionDispatch::BestStandardsSupport 中间件。因为 &lt;!DOCTYPE html&gt; 如此文所述，已触发了标准模式。而 ChromeFrame header 被移到 config.action_dispatch.default_headers 了。 记得移除所有使用到 ActionDispatch::BestStandardsSupport middleware 的参照： # 会抛出异常 config.middleware.insert_before(Rack::Lock, ActionDispatch::BestStandardsSupport) 并移除环境设置中的 config.action_dispatch.best_standards_support。 Rails 4.0 预编译不再自动从 vendor/assets 与 lib/assets 拷贝非 JS 或 CSS 的 assets。Rails 应用程序与 Engine 的开发者应将这些 assets 移到 app/assets 或设置 config.assets.precompile。 Rails 4.0 当 action 不知道如何处理 request 格式时会抛出 ActionController::UnknownFormat 异常。缺省是 406 Not Acceptable，但你可以改成别的 status code，在 Rails 3 只能是 406。 Rails 4.0 当 ParamsParser 无法解析 request params 时，会抛出通用的 ActionDispatch::ParamsParser::ParseError 异常。你可以 rescue 这个异常，而不是较为底层的 MultiJson::DecodeError。 Rails 4.0，当 Engine 安装到有 URL 前缀的宿主（hosting application）时，SCRIPT_NAME 已经将 URL 前缀适当地设置好了。不再需要设置 default_url_options[:script_name] 来覆写 URL 前缀。 Rails 4.0 弃用了 ActionController::Integration 请使用 ActionDispatch::Integration。 Rails 4.0 弃用了 ActionController::IntegrationTest 请使用 ActionDispatch::IntegrationTest。 Rails 4.0 弃用了 ActionController::PerformanceTest 请使用 ActionDispatch::PerformanceTest。 Rails 4.0 弃用了 ActionController::AbstractRequest 请使用 ActionDispatch::Request。 Rails 4.0 弃用了 ActionController::Request 请使用 ActionDispatch::Request。 Rails 4.0 弃用了 ActionController::AbstractResponse 请使用 ActionDispatch::Response。 Rails 4.0 弃用了 ActionController::Response 请使用 ActionDispatch::Response。 Rails 4.0 弃用了 ActionController::Routing 请使用 ActionDispatch::Routing。 2.7 Active Support Rails 4.0 移除了 ERB::Util#json_escape 的 j 别名。因为 j 已经被 ActionView::Helpers::JavaScriptHelper#escape_javascript 所使用。 2.8 Helpers 加载顺序 Rails 4.0 更改了 Helpers 的加载顺序。之前是将各目录的 Helpers 集合起来，并按字母排序加载。Rails 4.0 之后，Helpers 会按照目录原本加载的顺序，并在各自的目录里按字母依序加载。除非你特别使用了 helpers_path 参数，否则这个改动只会影响到从 Engine 加载 Helpers 的顺序。如果你正依赖加载的顺序，可以检查升级后这些 Helper 是否正常工作。如果想更改 Engine 加载的顺序，可以使用 config.railties_order= 方法。 2.9 Active Record Observer 与 Action Controller Sweeper Active Record Observer 与 Action Controller Sweeper 被抽成独立的 Gem：rails-observers。 2.10 sprockets-rails assets:precompile:primary 被移除了。请改用 assets:precompile。 config.assets.compress 选项应改成 config.assets.js_compressor： config.assets.js_compressor = :uglifier 2.11 sass-rails asset-url(&quot;rails.png&quot;, image) # 改成 asset-url(&quot;rails.png&quot;) from: JuanitoFatas" /><meta property="og:description" content="本篇讲解升级至新版 Rails 所需的步骤。同时也提供各版本的升级指导。 1. 一般建议 升级前先想好为何要升级：需要新功能？旧代码越来越难维护？有多少时间？有能力解决升级的兼容问题吗？等等。 1.1 测试覆盖度 最好的方式来确保应用程序升级后仍然正常工作，便是有全面的测试覆盖度。若没有撰写测试，将会花上许多时间，来处理升级带来的新变化。在升级前，先确保测试覆盖得够广吧！ 1.2 Ruby 版本 Rails 通常与最新的 Ruby 一起前进： Rails 3 以上需要高于 1.8.7 版本的 Ruby。 Rails 3.2.x 是最后支持 Ruby 1.8.7 的版本。 Rails 4 推荐使用 Ruby 2.0。 小贴士：Ruby 1.8.7 p248 与 p249 有 marshaling bugs，会让 Rails 无预警的 crash。REE 从 1.8.7-2010.02 之后的版本已经修正了这个问题。关于 Ruby 1.9，不要使用 1.9.1，有 segfaults 的问题，1.9 就用 1.9.3 吧。 定案： 强烈推荐使用 Ruby 2.0.0-p247 Ruby 1.9.3-p448 Ruby 1.8.7 退出历史舞台 1.3 HTTP PATCH 这里的路由作动词解。 Rails 4 更新操作的主要 HTTP 动词换成了 PATCH。当你在 config/routes.rb 以 RESTful 形式宣告某个 resource 时，PUT 仍会路由到 update action，只是多了个 PATCH，同样路由到 update action。 resources :users* # erb &lt;%= form_for @user do |f| %&gt; class UsersController &lt; ApplicationController def update # 代码不用改；偏好使用 PATCH，PUT 仍然可用。 end end 但是，当使用 form_for 来更新自定路由（使用 PUT HTTP 动词）的 resource 时， resources :users, do put :update_name, on: :member end &lt;%= form_for [ :update_name, @user ] do |f| %&gt; class UsersController &lt; ApplicationController def update_name # 要修改代码；form_for 会试著使用不存在的 PATCH 路由。 end end 若不是公有的 API，并且你有决定权换 HTTP 动词，那就把它从 PUT 改成 PATCH 吧。 在 Rails 4 对 /users/:id 做 PUT 请求，会被导向 update。所以要是 API 接受 PUT 请求，那没问题。Router 同时也会将来自 /users/:id 的 PATCH 请求导向 update action。 resources :users do patch :update_name, on: :member end 若此 action 正被公有的 API 使用，且你无权更改 HTTP 动词时，可更新 form，使用 PUT 动词： &lt;%= form_for [ :update_name, @user ], method: :put do |f| %&gt; 至于为什么要改成 PATCH，参考这篇文章。 1.3.1 关于 media types 的说明 RFC 5789 的勘误表示某些 media type 要用 PATCH 动词才正确，比如 JSON Patch。 Rails 没有原生支持 JSON Patch，但添加 JSON Patch 的支持非常简单： # 在 controller def update respond_to do |format| format.json do # perform a partial update @post.update params[:post] end format.json_patch do # perform sophisticated change end end end 在 config/initializers/json_patch.rb: Mime::Type.register &#39;application/json-patch+json&#39;, :json_patch 由于 JSON Patch 最近才有 RFC，仍未有好的 Ruby 函式库出现。Aaron Patterson 的 hana 是一个实作 JSON Patch 的 gem，但仍未完整支援 Spec 里所有最近更新的内容。 2. 从 Rails 3.2 升级到 Rails 4.0 注意：本小节仍在完善当中。 若你是 3.2 以前的版本，先升到 3.2 再试著升到 Rails 4.0。 以下是针对从 Rails 3.2 升级至 Rails 4.0 的说明。 2.1 Gemfile Rails 4.0 移除了 Gemfile 里的 assets group。升级至 4.0 时要移除这个 group，同时需要更新 config/application.rb： # Require the gems listed in Gemfile, including any gems # you&#39;ve limited to :test, :development, or :production. Bundler.require(:default, Rails.env) 2.2 vendor/plugins Rails 4.0 不再支援从 vendor/plugins 载入 plugins。 必须 将任何 plugins 包成 Gems ，再加入至 Gemfile。若你不想包成 Gem，则可将 plugin 移到 lib/my_plugin/*，并使用适当的 initializer：config/initializer/my_plugin.rb。 2.3 Active Record Rails 4.0 移除了 Active Record 的 identity map，因为这会导致某些关联的不一致性。也就是说 config.active_record.identity_map ，这个设置不再有作用。 Collection association 里的 delete 方法现在可接受 Fixnum 或 String 参数作为 record id，跟 destroy 类似。先前会抛出 ActiveRecord::AssociationTypeMismatch。从 Rails 4.0 起，delete 会自动在删除前，找到匹配的 id。 Rails 4.0 当 column 或 table 重命名时，相关的 index 也会重新命名。也就是不用写 rename index 的 migration 了。 Rails 4.0 将 serialized_attributes 及 attr_readonly 改为类别方法。即先前 self.serialized_attributes 改为 self.class.serialized_attributes。 Rails 4.0 引入 Strong Parameters 机制，故移除了 attr_accessible 与 attr_protected （抽离成 Protected Attributes gem）。 若你没有使用 Protected Attributes，可以把任何与 whitelist_attributes 或 mass_assignment_sanitizer 有关的选项移除。 Rails 4.0 要求 scope 必须是可调用的对象（Proc 或 lambda）。 scope :active, where(active: true) # 变成 scope :active, -&gt; { where active: true } Rails 4.0 弃用了 ActiveRecord::Fixtures，请使用 ActiveRecord::FixtureSet。 Rails 4.0 弃用了 ActiveRecord::TestCase，请使用 ActiveSupport::TestCase。 Rails 4.0 弃用了旧式，以 hash 为基础的 Finder API。这表示新的 Finder API 不再接受 “finder options”。 弃用了除了 find_by_...、find_by_...! 这两个以外的动态 Finder 方法，以下是如何修正： Rails 3 Rails 4 find_all_by_... 改成 where(...) find_last_by_... 改成 where(...).last scoped_by_... 改成 where(...) find_or_initialize_by_... 改成 find_or_initialize_by(...) find_or_create_by_... 改成 find_or_create_by(...) 注意！ where(...) 返回 relation，而不像旧式 Finder 方法会返回阵列，需要返回阵列请用 to_a。 注意！这些对应的方法，不会与先前的 Finder 方法，生成出相同的 SQL 语句。 要重新启用旧式的 Finder 方法，可以使用 activerecord-deprecated_finders gem。 2.4 Active Resource Rails 4.0 将 Active Resource 抽成独立的 Gem。若你仍需要此功能，将 Active Resource gem 加到 Gemfile。 2.5 Active Model Rails 4.0 更改了 ActiveModel::Validations::ConfirmationValidator 错误附加的方式。以前 confirmation 验证错误发生时，错误会加到 attribute 上，现在则会附加到 :#{attribute}_confirmation。 Rails 4.0 将 ActiveModel::Serializers::JSON.include_root_in_json 的缺省值改为 false，现在 Active Model Serializers 与 Active Record 对象缺省有著相同的行为。这表示你可以移除或注解掉这一行： # config/initializers/wrap_parameters.rb # Disable root element in JSON by default. # ActiveSupport.on_load(:active_record) do # self.include_root_in_json = false # end 2.6 Action Pack Rails 4.0 引入了 ActiveSupport::KeyGenerator，用来生成及检查已签署的 cookie。请在 config/initializers/secret_token.rb 加入新的 secret_key_base： # config/initializers/secret_token.rb Myapp::Application.config.secret_token = &#39;existing secret token&#39; Myapp::Application.config.secret_key_base = &#39;new secret key base&#39; 请注意！要等到使用者都使用你的 Rails 4.x app，并确保你不会降级到 Rails 3.x，才设置 secret_key_base。因为 cookie 签署的算法并不向下相容。忽略 deprecation warning 使用 secret_token 也是没问题的，只要你知道你自己在做什么就好。 如果有外部应用程序或是 JavaScript，需要能够读 Rails app 签署的 session cookies，在你还没有解决这些问题之前，不要设置 secret_key_base。 有设置 secret_key_base 的话，Rails 4.0 会加密以 cookie-based session 的内容。Rails 3.x 有签署，但未加密。签署的 cookie 是安全的，因为他们是经由你的 app 生成与签署。然而 cookie 的内容仍可被使用者看到，因此加密内容排除了此风险，且没有降低多少的效能。请阅读 Pull Request #9978 来了解更多有关 session cookie 加密的细节。 Rails 4.0 移除了 ActionController::Base.asset_path 选项。请使用 Assets Pipeline。 Rails 4.0 弃用了 ActionController::Base.page_cache_extension 选项。请使用 ActionController::Base.default_static_extension 来取代。 Rails 4.0 从 Action Pack 移除了 Action 与 Page 的 Cache。若要使用 caches_action、caches_pages 请加入 actionpack-action_caching gem。 Rails 4.0 移除了 XML 参数解析器。若要使用请加入 actionpack-xml_parser。 Rails 4.0 更改了缺省的 memcached 用户端，从 memcache-client 换成了 dalli，升级只需加入 gem &#39;dalli&#39; 至 Gemfile。 Rails 4.0 弃用了 Controller 的 dom_id 与 dom_class 方法（View 依然能用）。要用的话请在 Controller include ActionView::RecordIdentifier。 Rails 4.0 弃用了 link_to 的 :confirm 选项，应改写为 data: { confirm: &#39;Are you sure?&#39; }，link_to_if、link_to_unless 同样受影响。 Rails 4.0 修改了 assert_generates、assert_recognizes 以及 assert_routing 的工作方式。这些 assertions 会抛出 Assertion 而不是 ActionController::RoutingError` 错误。 在 Rails 4.0，如果定义了重复名称的路由时，会抛出 ArgumentError。请见下面两例（重复的 example_path）： get &#39;one&#39; =&gt; &#39;test#example&#39;, as: :example get &#39;two&#39; =&gt; &#39;test#example&#39;, as: :example resources :examples get &#39;clashing/:id&#39; =&gt; &#39;test#example&#39;, as: :example 第一个例子可直接换名字来解决。第二个例子可使用 resources 方法提供的 only 与 except 选项来限制生成出的路由，详见 Routing Guide Rails 4.0 更改了 route 有 unicode 字符的生成方式。现在 route 里可直接使用 unicode 字符，先前需要 escape 的作法不再需要了： get Rack::Utils.escape(&#39;こんにちは&#39;), controller: &#39;welcome&#39;, action: &#39;index&#39; 改为 get &#39;こんにちは&#39;, controller: &#39;welcome&#39;, action: &#39;index&#39; Rails 4.0 要求使用 match 的 route 必须指定 HTTP 动词: # Rails 3.x match &quot;/&quot; =&gt; &quot;root#index&quot; # 改成 match &quot;/&quot; =&gt; &quot;root#index&quot;, via: :get # 或 get &quot;/&quot; =&gt; &quot;root#index&quot; Rails 4.0 移除了 ActionDispatch::BestStandardsSupport 中间件。因为 &lt;!DOCTYPE html&gt; 如此文所述，已触发了标准模式。而 ChromeFrame header 被移到 config.action_dispatch.default_headers 了。 记得移除所有使用到 ActionDispatch::BestStandardsSupport middleware 的参照： # 会抛出异常 config.middleware.insert_before(Rack::Lock, ActionDispatch::BestStandardsSupport) 并移除环境设置中的 config.action_dispatch.best_standards_support。 Rails 4.0 预编译不再自动从 vendor/assets 与 lib/assets 拷贝非 JS 或 CSS 的 assets。Rails 应用程序与 Engine 的开发者应将这些 assets 移到 app/assets 或设置 config.assets.precompile。 Rails 4.0 当 action 不知道如何处理 request 格式时会抛出 ActionController::UnknownFormat 异常。缺省是 406 Not Acceptable，但你可以改成别的 status code，在 Rails 3 只能是 406。 Rails 4.0 当 ParamsParser 无法解析 request params 时，会抛出通用的 ActionDispatch::ParamsParser::ParseError 异常。你可以 rescue 这个异常，而不是较为底层的 MultiJson::DecodeError。 Rails 4.0，当 Engine 安装到有 URL 前缀的宿主（hosting application）时，SCRIPT_NAME 已经将 URL 前缀适当地设置好了。不再需要设置 default_url_options[:script_name] 来覆写 URL 前缀。 Rails 4.0 弃用了 ActionController::Integration 请使用 ActionDispatch::Integration。 Rails 4.0 弃用了 ActionController::IntegrationTest 请使用 ActionDispatch::IntegrationTest。 Rails 4.0 弃用了 ActionController::PerformanceTest 请使用 ActionDispatch::PerformanceTest。 Rails 4.0 弃用了 ActionController::AbstractRequest 请使用 ActionDispatch::Request。 Rails 4.0 弃用了 ActionController::Request 请使用 ActionDispatch::Request。 Rails 4.0 弃用了 ActionController::AbstractResponse 请使用 ActionDispatch::Response。 Rails 4.0 弃用了 ActionController::Response 请使用 ActionDispatch::Response。 Rails 4.0 弃用了 ActionController::Routing 请使用 ActionDispatch::Routing。 2.7 Active Support Rails 4.0 移除了 ERB::Util#json_escape 的 j 别名。因为 j 已经被 ActionView::Helpers::JavaScriptHelper#escape_javascript 所使用。 2.8 Helpers 加载顺序 Rails 4.0 更改了 Helpers 的加载顺序。之前是将各目录的 Helpers 集合起来，并按字母排序加载。Rails 4.0 之后，Helpers 会按照目录原本加载的顺序，并在各自的目录里按字母依序加载。除非你特别使用了 helpers_path 参数，否则这个改动只会影响到从 Engine 加载 Helpers 的顺序。如果你正依赖加载的顺序，可以检查升级后这些 Helper 是否正常工作。如果想更改 Engine 加载的顺序，可以使用 config.railties_order= 方法。 2.9 Active Record Observer 与 Action Controller Sweeper Active Record Observer 与 Action Controller Sweeper 被抽成独立的 Gem：rails-observers。 2.10 sprockets-rails assets:precompile:primary 被移除了。请改用 assets:precompile。 config.assets.compress 选项应改成 config.assets.js_compressor： config.assets.js_compressor = :uglifier 2.11 sass-rails asset-url(&quot;rails.png&quot;, image) # 改成 asset-url(&quot;rails.png&quot;) from: JuanitoFatas" /><link rel="canonical" href="https://hjijin.gz.com/blog/development/a-guide-for-upgrading-ruby-on-rails.html" /><meta property="og:url" content="https://hjijin.gz.com/blog/development/a-guide-for-upgrading-ruby-on-rails.html" /><meta property="og:site_name" content="Jim.h’ Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2013-11-18T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Ruby on Rails 升级指南" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jim Huang"},"dateModified":"2013-11-18T00:00:00+08:00","datePublished":"2013-11-18T00:00:00+08:00","description":"本篇讲解升级至新版 Rails 所需的步骤。同时也提供各版本的升级指导。 1. 一般建议 升级前先想好为何要升级：需要新功能？旧代码越来越难维护？有多少时间？有能力解决升级的兼容问题吗？等等。 1.1 测试覆盖度 最好的方式来确保应用程序升级后仍然正常工作，便是有全面的测试覆盖度。若没有撰写测试，将会花上许多时间，来处理升级带来的新变化。在升级前，先确保测试覆盖得够广吧！ 1.2 Ruby 版本 Rails 通常与最新的 Ruby 一起前进： Rails 3 以上需要高于 1.8.7 版本的 Ruby。 Rails 3.2.x 是最后支持 Ruby 1.8.7 的版本。 Rails 4 推荐使用 Ruby 2.0。 小贴士：Ruby 1.8.7 p248 与 p249 有 marshaling bugs，会让 Rails 无预警的 crash。REE 从 1.8.7-2010.02 之后的版本已经修正了这个问题。关于 Ruby 1.9，不要使用 1.9.1，有 segfaults 的问题，1.9 就用 1.9.3 吧。 定案： 强烈推荐使用 Ruby 2.0.0-p247 Ruby 1.9.3-p448 Ruby 1.8.7 退出历史舞台 1.3 HTTP PATCH 这里的路由作动词解。 Rails 4 更新操作的主要 HTTP 动词换成了 PATCH。当你在 config/routes.rb 以 RESTful 形式宣告某个 resource 时，PUT 仍会路由到 update action，只是多了个 PATCH，同样路由到 update action。 resources :users* # erb &lt;%= form_for @user do |f| %&gt; class UsersController &lt; ApplicationController def update # 代码不用改；偏好使用 PATCH，PUT 仍然可用。 end end 但是，当使用 form_for 来更新自定路由（使用 PUT HTTP 动词）的 resource 时， resources :users, do put :update_name, on: :member end &lt;%= form_for [ :update_name, @user ] do |f| %&gt; class UsersController &lt; ApplicationController def update_name # 要修改代码；form_for 会试著使用不存在的 PATCH 路由。 end end 若不是公有的 API，并且你有决定权换 HTTP 动词，那就把它从 PUT 改成 PATCH 吧。 在 Rails 4 对 /users/:id 做 PUT 请求，会被导向 update。所以要是 API 接受 PUT 请求，那没问题。Router 同时也会将来自 /users/:id 的 PATCH 请求导向 update action。 resources :users do patch :update_name, on: :member end 若此 action 正被公有的 API 使用，且你无权更改 HTTP 动词时，可更新 form，使用 PUT 动词： &lt;%= form_for [ :update_name, @user ], method: :put do |f| %&gt; 至于为什么要改成 PATCH，参考这篇文章。 1.3.1 关于 media types 的说明 RFC 5789 的勘误表示某些 media type 要用 PATCH 动词才正确，比如 JSON Patch。 Rails 没有原生支持 JSON Patch，但添加 JSON Patch 的支持非常简单： # 在 controller def update respond_to do |format| format.json do # perform a partial update @post.update params[:post] end format.json_patch do # perform sophisticated change end end end 在 config/initializers/json_patch.rb: Mime::Type.register &#39;application/json-patch+json&#39;, :json_patch 由于 JSON Patch 最近才有 RFC，仍未有好的 Ruby 函式库出现。Aaron Patterson 的 hana 是一个实作 JSON Patch 的 gem，但仍未完整支援 Spec 里所有最近更新的内容。 2. 从 Rails 3.2 升级到 Rails 4.0 注意：本小节仍在完善当中。 若你是 3.2 以前的版本，先升到 3.2 再试著升到 Rails 4.0。 以下是针对从 Rails 3.2 升级至 Rails 4.0 的说明。 2.1 Gemfile Rails 4.0 移除了 Gemfile 里的 assets group。升级至 4.0 时要移除这个 group，同时需要更新 config/application.rb： # Require the gems listed in Gemfile, including any gems # you&#39;ve limited to :test, :development, or :production. Bundler.require(:default, Rails.env) 2.2 vendor/plugins Rails 4.0 不再支援从 vendor/plugins 载入 plugins。 必须 将任何 plugins 包成 Gems ，再加入至 Gemfile。若你不想包成 Gem，则可将 plugin 移到 lib/my_plugin/*，并使用适当的 initializer：config/initializer/my_plugin.rb。 2.3 Active Record Rails 4.0 移除了 Active Record 的 identity map，因为这会导致某些关联的不一致性。也就是说 config.active_record.identity_map ，这个设置不再有作用。 Collection association 里的 delete 方法现在可接受 Fixnum 或 String 参数作为 record id，跟 destroy 类似。先前会抛出 ActiveRecord::AssociationTypeMismatch。从 Rails 4.0 起，delete 会自动在删除前，找到匹配的 id。 Rails 4.0 当 column 或 table 重命名时，相关的 index 也会重新命名。也就是不用写 rename index 的 migration 了。 Rails 4.0 将 serialized_attributes 及 attr_readonly 改为类别方法。即先前 self.serialized_attributes 改为 self.class.serialized_attributes。 Rails 4.0 引入 Strong Parameters 机制，故移除了 attr_accessible 与 attr_protected （抽离成 Protected Attributes gem）。 若你没有使用 Protected Attributes，可以把任何与 whitelist_attributes 或 mass_assignment_sanitizer 有关的选项移除。 Rails 4.0 要求 scope 必须是可调用的对象（Proc 或 lambda）。 scope :active, where(active: true) # 变成 scope :active, -&gt; { where active: true } Rails 4.0 弃用了 ActiveRecord::Fixtures，请使用 ActiveRecord::FixtureSet。 Rails 4.0 弃用了 ActiveRecord::TestCase，请使用 ActiveSupport::TestCase。 Rails 4.0 弃用了旧式，以 hash 为基础的 Finder API。这表示新的 Finder API 不再接受 “finder options”。 弃用了除了 find_by_...、find_by_...! 这两个以外的动态 Finder 方法，以下是如何修正： Rails 3 Rails 4 find_all_by_... 改成 where(...) find_last_by_... 改成 where(...).last scoped_by_... 改成 where(...) find_or_initialize_by_... 改成 find_or_initialize_by(...) find_or_create_by_... 改成 find_or_create_by(...) 注意！ where(...) 返回 relation，而不像旧式 Finder 方法会返回阵列，需要返回阵列请用 to_a。 注意！这些对应的方法，不会与先前的 Finder 方法，生成出相同的 SQL 语句。 要重新启用旧式的 Finder 方法，可以使用 activerecord-deprecated_finders gem。 2.4 Active Resource Rails 4.0 将 Active Resource 抽成独立的 Gem。若你仍需要此功能，将 Active Resource gem 加到 Gemfile。 2.5 Active Model Rails 4.0 更改了 ActiveModel::Validations::ConfirmationValidator 错误附加的方式。以前 confirmation 验证错误发生时，错误会加到 attribute 上，现在则会附加到 :#{attribute}_confirmation。 Rails 4.0 将 ActiveModel::Serializers::JSON.include_root_in_json 的缺省值改为 false，现在 Active Model Serializers 与 Active Record 对象缺省有著相同的行为。这表示你可以移除或注解掉这一行： # config/initializers/wrap_parameters.rb # Disable root element in JSON by default. # ActiveSupport.on_load(:active_record) do # self.include_root_in_json = false # end 2.6 Action Pack Rails 4.0 引入了 ActiveSupport::KeyGenerator，用来生成及检查已签署的 cookie。请在 config/initializers/secret_token.rb 加入新的 secret_key_base： # config/initializers/secret_token.rb Myapp::Application.config.secret_token = &#39;existing secret token&#39; Myapp::Application.config.secret_key_base = &#39;new secret key base&#39; 请注意！要等到使用者都使用你的 Rails 4.x app，并确保你不会降级到 Rails 3.x，才设置 secret_key_base。因为 cookie 签署的算法并不向下相容。忽略 deprecation warning 使用 secret_token 也是没问题的，只要你知道你自己在做什么就好。 如果有外部应用程序或是 JavaScript，需要能够读 Rails app 签署的 session cookies，在你还没有解决这些问题之前，不要设置 secret_key_base。 有设置 secret_key_base 的话，Rails 4.0 会加密以 cookie-based session 的内容。Rails 3.x 有签署，但未加密。签署的 cookie 是安全的，因为他们是经由你的 app 生成与签署。然而 cookie 的内容仍可被使用者看到，因此加密内容排除了此风险，且没有降低多少的效能。请阅读 Pull Request #9978 来了解更多有关 session cookie 加密的细节。 Rails 4.0 移除了 ActionController::Base.asset_path 选项。请使用 Assets Pipeline。 Rails 4.0 弃用了 ActionController::Base.page_cache_extension 选项。请使用 ActionController::Base.default_static_extension 来取代。 Rails 4.0 从 Action Pack 移除了 Action 与 Page 的 Cache。若要使用 caches_action、caches_pages 请加入 actionpack-action_caching gem。 Rails 4.0 移除了 XML 参数解析器。若要使用请加入 actionpack-xml_parser。 Rails 4.0 更改了缺省的 memcached 用户端，从 memcache-client 换成了 dalli，升级只需加入 gem &#39;dalli&#39; 至 Gemfile。 Rails 4.0 弃用了 Controller 的 dom_id 与 dom_class 方法（View 依然能用）。要用的话请在 Controller include ActionView::RecordIdentifier。 Rails 4.0 弃用了 link_to 的 :confirm 选项，应改写为 data: { confirm: &#39;Are you sure?&#39; }，link_to_if、link_to_unless 同样受影响。 Rails 4.0 修改了 assert_generates、assert_recognizes 以及 assert_routing 的工作方式。这些 assertions 会抛出 Assertion 而不是 ActionController::RoutingError` 错误。 在 Rails 4.0，如果定义了重复名称的路由时，会抛出 ArgumentError。请见下面两例（重复的 example_path）： get &#39;one&#39; =&gt; &#39;test#example&#39;, as: :example get &#39;two&#39; =&gt; &#39;test#example&#39;, as: :example resources :examples get &#39;clashing/:id&#39; =&gt; &#39;test#example&#39;, as: :example 第一个例子可直接换名字来解决。第二个例子可使用 resources 方法提供的 only 与 except 选项来限制生成出的路由，详见 Routing Guide Rails 4.0 更改了 route 有 unicode 字符的生成方式。现在 route 里可直接使用 unicode 字符，先前需要 escape 的作法不再需要了： get Rack::Utils.escape(&#39;こんにちは&#39;), controller: &#39;welcome&#39;, action: &#39;index&#39; 改为 get &#39;こんにちは&#39;, controller: &#39;welcome&#39;, action: &#39;index&#39; Rails 4.0 要求使用 match 的 route 必须指定 HTTP 动词: # Rails 3.x match &quot;/&quot; =&gt; &quot;root#index&quot; # 改成 match &quot;/&quot; =&gt; &quot;root#index&quot;, via: :get # 或 get &quot;/&quot; =&gt; &quot;root#index&quot; Rails 4.0 移除了 ActionDispatch::BestStandardsSupport 中间件。因为 &lt;!DOCTYPE html&gt; 如此文所述，已触发了标准模式。而 ChromeFrame header 被移到 config.action_dispatch.default_headers 了。 记得移除所有使用到 ActionDispatch::BestStandardsSupport middleware 的参照： # 会抛出异常 config.middleware.insert_before(Rack::Lock, ActionDispatch::BestStandardsSupport) 并移除环境设置中的 config.action_dispatch.best_standards_support。 Rails 4.0 预编译不再自动从 vendor/assets 与 lib/assets 拷贝非 JS 或 CSS 的 assets。Rails 应用程序与 Engine 的开发者应将这些 assets 移到 app/assets 或设置 config.assets.precompile。 Rails 4.0 当 action 不知道如何处理 request 格式时会抛出 ActionController::UnknownFormat 异常。缺省是 406 Not Acceptable，但你可以改成别的 status code，在 Rails 3 只能是 406。 Rails 4.0 当 ParamsParser 无法解析 request params 时，会抛出通用的 ActionDispatch::ParamsParser::ParseError 异常。你可以 rescue 这个异常，而不是较为底层的 MultiJson::DecodeError。 Rails 4.0，当 Engine 安装到有 URL 前缀的宿主（hosting application）时，SCRIPT_NAME 已经将 URL 前缀适当地设置好了。不再需要设置 default_url_options[:script_name] 来覆写 URL 前缀。 Rails 4.0 弃用了 ActionController::Integration 请使用 ActionDispatch::Integration。 Rails 4.0 弃用了 ActionController::IntegrationTest 请使用 ActionDispatch::IntegrationTest。 Rails 4.0 弃用了 ActionController::PerformanceTest 请使用 ActionDispatch::PerformanceTest。 Rails 4.0 弃用了 ActionController::AbstractRequest 请使用 ActionDispatch::Request。 Rails 4.0 弃用了 ActionController::Request 请使用 ActionDispatch::Request。 Rails 4.0 弃用了 ActionController::AbstractResponse 请使用 ActionDispatch::Response。 Rails 4.0 弃用了 ActionController::Response 请使用 ActionDispatch::Response。 Rails 4.0 弃用了 ActionController::Routing 请使用 ActionDispatch::Routing。 2.7 Active Support Rails 4.0 移除了 ERB::Util#json_escape 的 j 别名。因为 j 已经被 ActionView::Helpers::JavaScriptHelper#escape_javascript 所使用。 2.8 Helpers 加载顺序 Rails 4.0 更改了 Helpers 的加载顺序。之前是将各目录的 Helpers 集合起来，并按字母排序加载。Rails 4.0 之后，Helpers 会按照目录原本加载的顺序，并在各自的目录里按字母依序加载。除非你特别使用了 helpers_path 参数，否则这个改动只会影响到从 Engine 加载 Helpers 的顺序。如果你正依赖加载的顺序，可以检查升级后这些 Helper 是否正常工作。如果想更改 Engine 加载的顺序，可以使用 config.railties_order= 方法。 2.9 Active Record Observer 与 Action Controller Sweeper Active Record Observer 与 Action Controller Sweeper 被抽成独立的 Gem：rails-observers。 2.10 sprockets-rails assets:precompile:primary 被移除了。请改用 assets:precompile。 config.assets.compress 选项应改成 config.assets.js_compressor： config.assets.js_compressor = :uglifier 2.11 sass-rails asset-url(&quot;rails.png&quot;, image) # 改成 asset-url(&quot;rails.png&quot;) from: JuanitoFatas","headline":"Ruby on Rails 升级指南","mainEntityOfPage":{"@type":"WebPage","@id":"https://hjijin.gz.com/blog/development/a-guide-for-upgrading-ruby-on-rails.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://hjijin.gz.com/blog/assets/img/mynameis007.png"},"name":"Jim Huang"},"url":"https://hjijin.gz.com/blog/development/a-guide-for-upgrading-ruby-on-rails.html"}</script><meta name="keywords" content="Developer,Ruby,Javascript,MySQL,VUE"><meta name="theme-color" content="rgb(25,55,71)"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Jim.h' Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="application-name" content="Jim.h' Blog"><meta name="generator" content="Hydejack v9.1.6" /><link rel="alternate" href="https://hjijin.gz.com/blog/development/a-guide-for-upgrading-ruby-on-rails.html" hreflang="zh-cn, en-us"><link type="application/atom+xml" rel="alternate" href="https://hjijin.gz.com/blog/feed.xml" title="Jim.h&apos; Blog" /><link rel="shortcut icon" href="/blog/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/blog/assets/icons/icon-192x192.png"><link rel="manifest" href="/blog/assets/site.webmanifest"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preload" href="/blog/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"><link rel="dns-prefetch" href="/blog/assets/js/search-worker-9.1.6.js" as="worker" id="_hrefSearch"><link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> <script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script"),e=(n.src=e,t&&a(n,"load",t,{once:!0}),c.scripts[0]);return e.parentNode.insertBefore(n,e),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/blog/'; w._publicPath = '/blog/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = true; w._advertise = false; w._search = { DATA_URL: '/blog/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/blog/', INDEX_KEY: 'index--2024-05-13T13:33:24+08:00', }; w._clapButton = false; }(window);</script> <script async src="/blog/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script><style id="_styleInline"> .clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,body,p,hr,.hr,.hr-after::after,.hr-bottom,.message,.note-sm,.note,#markdown-toc,.navbar,.nav-btn-bar,.nav-btn,.content .avatar{transition:none}#_dark-mode{font-size:1.25rem}@media screen{body.light-mode{--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg)}body.light-mode .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}body.dark-mode{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body.dark-mode .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}}@media screen and (prefers-color-scheme: dark){body{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.tippy-content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}}html{--font-family: Noto Sans,Helvetica,Arial,sans-serif;--font-family-heading: Roboto Slab,Helvetica,Arial,sans-serif;--code-font-family: JetBrains Mono,Menlo,Monaco,Consolas,monospace;--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0,0,0,0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg);--root-font-size: 15px;--root-font-size-medium: 16px;--root-font-size-large: 17px;--root-font-size-print: 8pt;--root-line-height: 1.75;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 700;--content-width-5: 54rem;--content-margin-5: 4rem;--sidebar-width: 21rem;--half-content: 31rem;--break-point-3: 64em;--break-point-5: 86em;--break-point-dynamic: 1664px}html .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:var(--font-family);font-size:var(--root-font-size);line-height:var(--root-line-height)}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}.content img,.img,.content video,.video{max-width:100%;height:auto}.lead{margin-left:-1rem;margin-right:-1rem;margin-bottom:1.5rem}img.lead,video.lead{display:block;max-width:calc(100% + 2rem);width:calc(100% + 2rem);height:auto}.heading,.f1,h1,.h1,.f2,h2,.h2,.f3,h3,.h3,.f4,h4,.h4,.post-date,.sidebar-nav-item,.sidebar-nav-subitem,.f5,h5,.h5,.f6,h6,.h6{font-family:var(--font-family-heading);font-weight:var(--font-weight-heading)}.f1,h1,.h1{font-size:2rem;line-height:1.3}.f2,h2,.h2{font-size:1.5rem;line-height:1.4}.f3,h3,.h3{font-size:1.2em;line-height:1.5}.f4,h4,.h4,.post-date,.sidebar-nav-item,.sidebar-nav-subitem{font-size:1.08rem;line-height:1.6}.f5,h5,.h5{font-size:1.04rem;line-height:1.7}.f6,h6,.h6{font-size:1rem}.content h1>a,.content .h1>a{text-decoration:none;border-bottom:none}@media screen and (max-width: 42em){.content h1,.content .h1{font-size:1.7rem;line-height:1.35}}@media screen and (min-width: 86em){.content h1,.content .h1{font-size:2.4rem;line-height:1.25}}@media screen and (min-width: 1664px){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{width:calc(100% + 50vw - 32rem);font-size:3rem;line-height:1.2}}@media screen and (min-width: 124em){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{font-size:4rem;line-height:1.1}}h1,h2,h3,.h1,.h2,.h3{margin:4rem 0 1rem}h4,h5,h6,.h4,.post-date,.h5,.h6{margin:3rem 0 .5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr,.hr{border:0;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-after::after{content:"";display:block;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-bottom{border-bottom:1px solid var(--border-color);padding-bottom:.75rem;margin-bottom:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{position:relative;margin-bottom:2rem}@media screen and (min-width: 1664px){body:not(.no-third-column) .page>header>.lead+.note-sm,body:not(.no-third-column) .page>header>.lead+.note,body:not(.no-third-column) .page>header>.lead+#markdown-toc,body:not(.no-third-column) .page>header>a.no-hover+.note-sm,body:not(.no-third-column) .page>header>a.no-hover+.note,body:not(.no-third-column) .page>header>a.no-hover+#markdown-toc{position:absolute;right:-25rem;width:21rem;bottom:0;margin-bottom:0}}.page-title,.post-title{margin-top:0}.post-date{display:flex;justify-content:space-between;margin-top:-.6rem;height:2rem;margin-bottom:.85rem;color:var(--gray)}.post-date>.ellipsis,#breadcrumbs.post-date>ul{cursor:pointer}.post-date [class^="icon-"]{display:inline-block;font-size:smaller;margin-right:.25rem}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message,.note-sm,.note,#markdown-toc{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}.note-sm,.note,#markdown-toc{background:transparent;color:var(--body-color);font-size:smaller;border-left:1px solid var(--border-color);padding:1.2rem 1rem 0 1rem;margin:1rem -1rem;position:relative}.note-sm:before,.note:before,#markdown-toc:before{font-size:0.667rem;font-weight:bold;font-style:normal;letter-spacing:.025rem;text-transform:uppercase;color:var(--menu-text);position:absolute;top:0}.note-sm[title]:before,[title].note:before,[title]#markdown-toc:before{content:attr(title) !important}.note{font-size:1rem}@media screen{body::before{content:'';width:.5rem;background:var(--gray-bg);position:fixed;left:0;top:0;bottom:0}}@media (min-width: 64em){body::before{width:21rem}}@media (min-width: 1664px){body::before{width:calc(50% - 31rem)}}@media screen and (min-width: 42em){html{font-size:var(--root-font-size-medium)}}@media screen and (min-width: 124em){html{font-size:var(--root-font-size-large)}}#breadcrumbs>ul{height:1rem;margin:-1.5rem 0 .5rem;padding:0;font-size:.667rem;color:var(--menu-text);text-transform:uppercase;width:100%;list-style:none}#breadcrumbs>ul>li{display:inline}#breadcrumbs>ul>li a{color:var(--gray);text-decoration:none;border-bottom:none}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt1{margin-top:1rem}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.ml1{margin-left:1rem}.mr1{margin-right:1rem}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sixteen-ten{position:relative}.sixteen-ten::before{display:block;content:"";width:100%;padding-top:62.5%}.sixteen-ten>*{position:absolute;top:0;left:0;right:0;bottom:0}.four-three{position:relative}.four-three::before{display:block;content:"";width:100%;padding-top:75%}.four-three>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.larger{font-size:larger}.smaller{font-size:smaller}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.ellipsis,#breadcrumbs>ul{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.border{border:1px solid var(--border-color)}@media (min-width: 42em){.border-radius,.lead,.page .aspect-ratio.sixteen-nine.lead{border-radius:.5rem}}.fallback-img{background-position:center;background-repeat:no-repeat;background-image:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuMDQ4ODI4LCAwLCAwLCAwLjA0Nzk5MSwgNTQuOTk5OTczLCAyMC40MjgxNDgpIj4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTk1OS44ODQgMTI4YzAuMDQwIDAuMDM0IDAuMDgyIDAuMDc2IDAuMTE2IDAuMTE2djc2Ny43N2MtMC4wMzQgMC4wNDAtMC4wNzYgMC4wODItMC4xMTYgMC4xMTZoLTg5NS43N2MtMC4wNDAtMC4wMzQtMC4wODItMC4wNzYtMC4xMTQtMC4xMTZ2LTc2Ny43NzJjMC4wMzQtMC4wNDAgMC4wNzYtMC4wODIgMC4xMTQtMC4xMTRoODk1Ljc3ek05NjAgNjRoLTg5NmMtMzUuMiAwLTY0IDI4LjgtNjQgNjR2NzY4YzAgMzUuMiAyOC44IDY0IDY0IDY0aDg5NmMzNS4yIDAgNjQtMjguOCA2NC02NHYtNzY4YzAtMzUuMi0yOC44LTY0LTY0LTY0djB6Ii8+CiAgICA8cGF0aCBzdHlsZT0iZmlsbDpyZ2JhKDEyOCwxMjgsMTI4LC4zMykiIGQ9Ik04MzIgMjg4YzAgNTMuMDIwLTQyLjk4IDk2LTk2IDk2cy05Ni00Mi45OC05Ni05NiA0Mi45OC05NiA5Ni05NiA5NiA0Mi45OCA5NiA5NnoiLz4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTg5NiA4MzJoLTc2OHYtMTI4bDIyNC0zODQgMjU2IDMyMGg2NGwyMjQtMTkyeiIvPgogIDwvZz4KPC9zdmc+")}hy-push-state a{color:var(--body-color)}@supports not ((text-decoration-thickness: initial) and (text-underline-offset: initial)){hy-push-state a{text-decoration:none;border-bottom:2px solid}}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){hy-push-state a{text-decoration-style:solid;text-underline-offset:.35rem;text-decoration-thickness:2px}}hy-push-state a.no-hover{border-bottom:none;text-decoration-thickness:unset;text-underline-offset:unset}.content a:not(.btn):not(.no-hover){border-color:var(--accent-color-faded)}@supports (text-decoration-thickness: initial) and (text-underline-offset: initial){.content a:not(.btn):not(.no-hover){text-decoration-color:var(--accent-color-faded)}}.content .aspect-ratio{overflow:hidden}.content .aspect-ratio img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden;display:block;z-index:4}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 1664px){hy-drawer{width:calc(50% - 31rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:rgba(255,255,255,0.75);text-align:center;min-height:100vh}.sidebar.invert{color:rgba(32,32,32,0.75)}.sidebar a{color:#fff;border-bottom-color:rgba(255,255,255,0.2);text-decoration-color:rgba(255,255,255,0.2)}.sidebar.invert a{color:#222;border-bottom-color:rgba(32,32,32,0.2);text-decoration-color:rgba(32,32,32,0.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center / cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,0.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 50%, rgba(32,32,32,0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>a.sidebar-title{text-decoration:none}.sidebar-about>a.sidebar-title>h2{margin:0;padding-bottom:.5rem}.sidebar-about>a.sidebar-title::after{content:'';display:block;border-bottom:2px solid;margin:0 auto .5rem;width:4rem;border-color:rgba(255,255,255,0.2);transition:border-color 250ms}.sidebar-about>a.sidebar-title:hover::after{border-color:#fff;transition:border-color 50ms}.sidebar.invert .sidebar-about>a.sidebar-title::after{border-color:rgba(32,32,32,0.2)}.sidebar.invert .sidebar-about>a.sidebar-title:hover::after{border-color:#222}.sidebar-nav>ul{list-style:none;padding-left:0}.sidebar-nav-item{display:inline-block;margin-bottom:.5rem}@media (min-width: 64em){#_main.no-drawer #_menu{display:none}#_main.no-drawer .nav-btn-bar>:nth-child(2){border:none}}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem;text-decoration:none;border-bottom-width:2px;border-bottom-style:solid}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-top,.fixed-bottom{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{position:relative;padding-top:0;padding-bottom:0;min-height:0;max-height:5rem}.nav-btn-bar{margin:0 -1rem;background-color:white;background-color:var(--body-bg);height:5rem;display:flex;align-items:center;position:relative}.nav-btn-bar>:first-child,.nav-btn-bar>:last-child{border:none}.nav-btn{background:none;border:none;text-decoration:none;display:flex;align-items:center;justify-content:center;width:3.25rem;height:5rem;color:var(--menu-text);border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);margin-left:-1px}#markdown-toc{margin:2rem -1rem 2rem calc(-1rem + 1px);padding-left:2.5rem;padding-bottom:.5rem}#markdown-toc:before{left:1rem}@media screen and (min-width: 1664px){body:not(.no-toc) #markdown-toc{position:absolute;z-index:4;width:20.5rem;right:0;margin:auto;overflow:auto}}@media screen and (min-width: 1664px){body.no-break-layout:not(.no-toc) #markdown-toc{width:calc(50% - 31rem)}}.content{margin-left:auto;margin-right:auto;padding:8rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;min-height:100vh}}@media screen and (min-width: 42em){.content{max-width:42rem}}@media screen and (min-width: 54em){.content{max-width:48rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 86em){.content{padding-top:9rem;margin-left:25rem;margin-right:4rem;max-width:54rem}}@media screen and (min-width: 1664px){.content{margin:auto}}.large-only{display:none}@media screen and (min-width: 1664px){.large-only{display:block}}.avatar{width:7rem;height:7rem;border-radius:100%;overflow:hidden;display:inline-block}.avatar img{width:100%}.content .avatar{float:right;box-sizing:content-box;border:1rem solid var(--body-bg);transition:border-color 1s ease;margin-top:-1.5rem;margin-right:-1rem}.sidebar a{text-shadow:rgba(0,0,0,0.25) 0.1rem 0.1rem 0.15rem}.post-title,.page-title{word-break:keep-all}.sidebar{text-align:center}.sidebar-sticky{height:100%;padding-top:5%;position:fixed}.sidebar-nav-item{padding:.25rem 0;width:100%}.sidebar-nav-subitem{width:100%;padding:.25rem 0;display:inline-block}.sidebar-nav-subitem:last-child{margin:0 0 4px 0}.list-wrapper{text-align:left;width:18rem;display:flex}.list-body{margin:0;text-align:left}.sidebar-about>a.sidebar-title::after{width:9rem}.spread-btn{background:none;border:none;color:white;cursor:pointer;text-align:right;width:100%}.spread-btn:hover{color:#ff8080}input[type=checkbox]{display:none}input[type=checkbox] ~ ul{height:0;transform:scaleY(0);transition:transform .2s ease-out}input[type=checkbox]:checked ~ ul{height:100%;list-style:none;transform-origin:top;transform:scaleY(1);transition:transform .2s ease-out}@keyframes fadeIn{0%{opacity:0}20%{opacity:0}40%{opacity:0.4}60%{opacity:0.6}80%{opacity:0.8}100%{opacity:1}}.no-fouc{-webkit-animation-duration:1s;-webkit-animation-name:fadeIn;animation-duration:1s;animation-iteration-count:1;animation-name:fadeIn;opacity:0;opacity:1}.note:before{content:"Note"}.page>header>.note-sm:before,.page>header>.note:before,.page>header>#markdown-toc:before{content:"Description"}#markdown-toc:before{content:"Table of Contents"}.layout-resume .note-sm:before,.layout-resume .note:before,.layout-resume #markdown-toc:before{content:"Summary"}html{--accent-color: rgb(51,205,255);--accent-color-faded: rgba(51,205,255,0.5);--accent-color-highlight: rgba(51,205,255,0.1);--accent-color-darkened: #0dc4ff;--theme-color: rgb(25,55,71);--dark-mode-body-bg: #2a2d2f;--dark-mode-border-color: #363a3d} .clearfix,main:not(.layout-resume) .columns::after{content:"";display:table;clear:both}.color-transition,main:not(.layout-resume) .project-card{transition:none}main:not(.layout-resume) .columns{margin-left:-1rem;display:flex;flex-wrap:wrap;contain:content;padding-top:1rem;margin-top:1rem;padding-right:1rem;margin-right:-1rem}main:not(.layout-resume) .column{float:left;padding-left:1rem;margin-bottom:2rem;width:100%;display:flex}@media screen and (min-width: 42em){main:not(.layout-resume) .columns{margin-left:-2rem;margin-right:-2rem}main:not(.layout-resume) .column-1-2{width:50%}}@media screen and (min-width: 1664px){main:not(.layout-resume) .columns-break{width:calc(50vw + 25rem)}main:not(.layout-resume) .columns-break>.column-1-2,main:not(.layout-resume) .columns-break>.column-1{width:27.5rem}}@media print{main:not(.layout-resume) .columns{display:block}main:not(.layout-resume) .column{display:block;width:50%}}main:not(.layout-resume) .project-card{width:100%;color:var(--gray-text);background-color:var(--gray-bg);padding-bottom:1rem;position:relative;overflow:hidden;box-shadow:0.125rem 0.125rem 1rem rgba(0,0,0,0.2);contain:content;border-radius:.5rem;page-break-inside:avoid;transition:transform 500ms ease;will-change:transform}main:not(.layout-resume) .project-card:hover{transform:translateY(-0.25rem);transition:transform 250ms ease}main:not(.layout-resume) .project-card>a.flip-project{display:block}main:not(.layout-resume) .project-card>a.flip-project .project-card-img{margin-bottom:0}main:not(.layout-resume) .project-card>a.flip-project .project-card-img img{display:block;border-top-left-radius:.5rem;border-top-right-radius:.5rem}main:not(.layout-resume) .project-card a{z-index:1}main:not(.layout-resume) .project-card a.fill-card{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0}main:not(.layout-resume) .project-card>.project-card-title,main:not(.layout-resume) .project-card>.project-card-text{text-align:center;padding:0 1rem}main:not(.layout-resume) .project-card>.project-card-title{display:block;font-size:1.08rem;margin-top:.75rem;margin-bottom:.25rem;color:inherit}main:not(.layout-resume) .project-card>.project-card-text{margin:.25rem 0}main:not(.layout-resume) .column-1>.project-card>.project-card-title{font-size:1.2rem}main:not(.layout-resume) .column-1>.project-card>.project-card-text{font-size:1rem}</style><link rel="preload" as="style" href="/blog/assets/css/hydejack-9.1.6.css" id="_stylePreload"><link rel="preload" as="style" href="/blog/assets/icomoon/style.css" id="_iconsPreload"><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload"> <script> setRel('_stylePreload'); setRel('_iconsPreload'); /**/setRel('_fontsPreload');/**/ </script> <noscript><link rel="stylesheet" href="/blog/assets/css/hydejack-9.1.6.css"><link rel="stylesheet" href="/blog/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap"> </noscript><body class="no-break-layout no-large-headings"> <script> window._sunrise = 6; window._sunset = 18; !function(e,s){var d="light-mode",o="dark-mode",a=(new Date).getHours();"matchMedia"in e&&e.matchMedia("(prefers-color-scheme)")||(e=(a=a<=e._sunrise||a>=e._sunset?o:d)==o?d:o,s.body.classList.add(a),s.body.classList.remove(e))}(window,document); </script> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/blog/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange ><div id="_navbar" class="navbar fixed-top"><div class="content"> <span class="sr-only">Jump to:</span><div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a><div class="nav-span"></div></div></div></div><hr class="sr-only" hidden /><main id="_main" class="content layout-post" role="main" ><nav id="breadcrumbs" class="screen-only"><ul><li><a href="/blog/">home</a><li> <span>/</span> <a href="/blog/development/">development</a><li> <span>/</span> <span>a-guide-for-upgrading-ruby-on-rails.html</span></ul></nav><article id="post-development-a-guide-for-upgrading-ruby-on-rails" class="page post mb6" role="article"><header><h1 class="post-title flip-project-title"> Ruby on Rails 升级指南</h1><div class="post-date"> <span class="ellipsis mr1"> <time datetime="2013-11-18T00:00:00+08:00">18 Nov 2013</time> in <a href="/blog/development/" class="flip-title">技术</a> on <a href="/blog/tag-server/" class="flip-title">后端/架构</a>, <span>Rails</span> </span></div><div class="hr pb0"></div></header><p>本篇讲解升级至新版 Rails 所需的步骤。同时也提供各版本的升级指导。<h3 id="1-一般建议">1. 一般建议</h3><p>升级前先想好为何要升级：需要新功能？旧代码越来越难维护？有多少时间？有能力解决升级的兼容问题吗？等等。<h4 id="11-测试覆盖度">1.1 测试覆盖度</h4><p>最好的方式来确保应用程序升级后仍然正常工作，便是有全面的测试覆盖度。若没有撰写测试，将会花上许多时间，来处理升级带来的新变化。在升级前，先确保测试覆盖得够广吧！<h4 id="12-ruby-版本">1.2 Ruby 版本</h4><p>Rails 通常与最新的 Ruby 一起前进：<ul><li>Rails 3 以上需要高于 1.8.7 版本的 Ruby。<li>Rails 3.2.x 是最后支持 Ruby 1.8.7 的版本。<li>Rails 4 推荐使用 Ruby 2.0。</ul><p>小贴士：Ruby 1.8.7 p248 与 p249 有 marshaling bugs，会让 Rails 无预警的 crash。REE 从 1.8.7-2010.02 之后的版本已经修正了这个问题。关于 Ruby 1.9，不要使用 1.9.1，有 segfaults 的问题，1.9 就用 1.9.3 吧。<p>定案：<ul><li><strong>强烈推荐使用 Ruby 2.0.0-p247</strong><li>Ruby 1.9.3-p448<li><a href="https://www.ruby-lang.org/zh_cn/news/2013/06/30/we-retire-1-8-7/">Ruby 1.8.7 退出历史舞台</a></ul><h4 id="13-http-patch">1.3 HTTP PATCH</h4><blockquote><p>这里的路由作动词解。</blockquote><p>Rails 4 更新操作的主要 HTTP 动词换成了 <code class="language-plaintext highlighter-rouge">PATCH</code>。当你在 <code class="language-plaintext highlighter-rouge">config/routes.rb</code> 以 <em>RESTful</em> 形式宣告某个 resource 时，<code class="language-plaintext highlighter-rouge">PUT</code> 仍会路由到 <code class="language-plaintext highlighter-rouge">update</code> action，只是多了个 <code class="language-plaintext highlighter-rouge">PATCH</code>，同样路由到 <code class="language-plaintext highlighter-rouge">update</code> action。<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">resources</span> <span class="ss">:users</span><span class="o">*</span></code></pre></figure><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># erb</span>
  <span class="o">&lt;</span><span class="sx">%= form_for @user do |f| %&gt;</span></code></pre></figure><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">update</span>
      <span class="c1"># 代码不用改；偏好使用 PATCH，PUT 仍然可用。</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure><p>但是，当使用 <code class="language-plaintext highlighter-rouge">form_for</code> 来更新自定路由（使用 <code class="language-plaintext highlighter-rouge">PUT</code> HTTP 动词）的 resource 时，<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="k">do</span>
    <span class="n">put</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
  <span class="k">end</span></code></pre></figure><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="o">&lt;</span><span class="sx">%= form_for [ :update_name, @user ] do |f| %&gt;</span></code></pre></figure><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">update_name</span>
      <span class="c1"># 要修改代码；form_for 会试著使用不存在的 PATCH 路由。</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure><p>若不是公有的 API，并且你有决定权换 HTTP 动词，那就把它从 <code class="language-plaintext highlighter-rouge">PUT</code> 改成 <code class="language-plaintext highlighter-rouge">PATCH</code> 吧。<br /> 在 Rails 4 对 <code class="language-plaintext highlighter-rouge">/users/:id</code> 做 <code class="language-plaintext highlighter-rouge">PUT</code> 请求，会被导向 <code class="language-plaintext highlighter-rouge">update</code>。所以要是 API 接受 <code class="language-plaintext highlighter-rouge">PUT</code> 请求，那没问题。Router 同时也会将来自 <code class="language-plaintext highlighter-rouge">/users/:id</code> 的 <code class="language-plaintext highlighter-rouge">PATCH</code> 请求导向 <code class="language-plaintext highlighter-rouge">update</code> action。<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
  <span class="k">end</span></code></pre></figure><p>若此 action 正被公有的 API 使用，且你无权更改 HTTP 动词时，可更新 form，使用 <code class="language-plaintext highlighter-rouge">PUT</code> 动词：<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="o">&lt;</span><span class="sx">%= form_for [ :update_name, @user ], method: :put do |f| %&gt;</span></code></pre></figure><p>至于为什么要改成 <code class="language-plaintext highlighter-rouge">PATCH</code>，参考<a href="http://weblog.rubyonrails.org/2012/2/25/edge-rails-patch-is-the-new-primary-http-method-for-updates/">这篇文章</a>。<h5 id="131-关于-media-types-的说明">1.3.1 关于 media types 的说明</h5><p><a href="http://www.rfc-editor.org/errata_search.php?rfc=5789">RFC 5789 的勘误</a>表示某些 media type 要用 <code class="language-plaintext highlighter-rouge">PATCH</code> 动词才正确，比如 JSON Patch。<p>Rails 没有原生支持 JSON Patch，但添加 JSON Patch 的支持非常简单：<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># 在 controller</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="k">do</span>
        <span class="c1"># perform a partial update</span>
        <span class="vi">@post</span><span class="p">.</span><span class="nf">update</span> <span class="n">params</span><span class="p">[</span><span class="ss">:post</span><span class="p">]</span>
      <span class="k">end</span>

      <span class="nb">format</span><span class="p">.</span><span class="nf">json_patch</span> <span class="k">do</span>
        <span class="c1"># perform sophisticated change</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure><h3 id="在-configinitializersjson_patchrb">在 config/initializers/json_patch.rb:</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mime::Type.register 'application/json-patch+json', :json_patch
</code></pre></div></div><p>由于 JSON Patch 最近才有 RFC，仍未有好的 Ruby 函式库出现。Aaron Patterson 的 <a href="https://github.com/tenderlove/hana">hana</a> 是一个实作 JSON Patch 的 gem，但仍未完整支援 Spec 里所有最近更新的内容。<h3 id="2-从-rails-32-升级到-rails-40">2. 从 Rails 3.2 升级到 Rails 4.0</h3><p><strong>注意：本小节仍在完善当中。</strong><br /> 若你是 3.2 以前的版本，先升到 3.2 再试著升到 Rails 4.0。<br /> 以下是针对从 Rails 3.2 升级至 Rails 4.0 的说明。<h4 id="21-gemfile">2.1 Gemfile</h4><p>Rails 4.0 移除了 Gemfile 里的 <code class="language-plaintext highlighter-rouge">assets</code> group。升级至 4.0 时要移除这个 group，同时需要更新 <code class="language-plaintext highlighter-rouge">config/application.rb</code>：<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># Require the gems listed in Gemfile, including any gems</span>
  <span class="c1"># you've limited to :test, :development, or :production.</span>
  <span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">)</span></code></pre></figure><h4 id="22-vendorplugins">2.2 vendor/plugins</h4><p>Rails 4.0 不再支援从 <code class="language-plaintext highlighter-rouge">vendor/plugins</code> 载入 plugins。 <strong>必须</strong> 将任何 plugins 包成 Gems ，再加入至 Gemfile。若你不想包成 Gem，则可将 plugin 移到 <code class="language-plaintext highlighter-rouge">lib/my_plugin/*</code>，并使用适当的 initializer：<code class="language-plaintext highlighter-rouge">config/initializer/my_plugin.rb</code>。<h4 id="23-active-record">2.3 Active Record</h4><ul><li>Rails 4.0 移除了 Active Record 的 identity map，因为这会导致<a href="https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6">某些关联的不一致性</a>。也就是说 <code class="language-plaintext highlighter-rouge">config.active_record.identity_map</code> ，这个设置不再有作用。<li>Collection association 里的 <code class="language-plaintext highlighter-rouge">delete</code> 方法现在可接受 <code class="language-plaintext highlighter-rouge">Fixnum</code> 或 <code class="language-plaintext highlighter-rouge">String</code> 参数作为 record id，跟 <code class="language-plaintext highlighter-rouge">destroy</code> 类似。先前会抛出 <code class="language-plaintext highlighter-rouge">ActiveRecord::AssociationTypeMismatch</code>。从 Rails 4.0 起，<code class="language-plaintext highlighter-rouge">delete</code> 会自动在删除前，找到匹配的 <code class="language-plaintext highlighter-rouge">id</code>。<li>Rails 4.0 当 column 或 table 重命名时，相关的 index 也会重新命名。也就是不用写 rename index 的 migration 了。<li>Rails 4.0 将 <code class="language-plaintext highlighter-rouge">serialized_attributes</code> 及 <code class="language-plaintext highlighter-rouge">attr_readonly</code> 改为类别方法。即先前 <code class="language-plaintext highlighter-rouge">self.serialized_attributes</code> 改为 <code class="language-plaintext highlighter-rouge">self.class.serialized_attributes</code>。<li>Rails 4.0 引入 Strong Parameters 机制，故移除了 <code class="language-plaintext highlighter-rouge">attr_accessible</code> 与 <code class="language-plaintext highlighter-rouge">attr_protected</code> （抽离成 <a href="https://github.com/rails/protected_attributes">Protected Attributes gem</a>）。<li>若你没有使用 Protected Attributes，可以把任何与 <code class="language-plaintext highlighter-rouge">whitelist_attributes</code> 或 <code class="language-plaintext highlighter-rouge">mass_assignment_sanitizer</code> 有关的选项移除。<li>Rails 4.0 要求 scope 必须是可调用的对象（Proc 或 lambda）。</ul><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">true</span><span class="p">)</span>
  <span class="c1"># 变成</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span></code></pre></figure><ul><li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActiveRecord::Fixtures</code>，请使用 <code class="language-plaintext highlighter-rouge">ActiveRecord::FixtureSet</code>。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActiveRecord::TestCase</code>，请使用 <code class="language-plaintext highlighter-rouge">ActiveSupport::TestCase</code>。<li>Rails 4.0 弃用了旧式，以 hash 为基础的 Finder API。这表示新的 Finder API 不再接受 “finder options”。<li><p>弃用了除了 <code class="language-plaintext highlighter-rouge">find_by_...</code>、<code class="language-plaintext highlighter-rouge">find_by_...!</code> 这两个以外的动态 Finder 方法，以下是如何修正：<table><thead><tr><th>Rails 3<th>Rails 4<tbody><tr><td><code class="language-plaintext highlighter-rouge">find_all_by_...</code><td>改成 <code class="language-plaintext highlighter-rouge">where(...)</code><tr><td><code class="language-plaintext highlighter-rouge">find_last_by_...</code><td>改成 <code class="language-plaintext highlighter-rouge">where(...).last</code><tr><td><code class="language-plaintext highlighter-rouge">scoped_by_...</code><td>改成 <code class="language-plaintext highlighter-rouge">where(...)</code><tr><td><code class="language-plaintext highlighter-rouge">find_or_initialize_by_...</code><td>改成 <code class="language-plaintext highlighter-rouge">find_or_initialize_by(...)</code><tr><td><code class="language-plaintext highlighter-rouge">find_or_create_by_...</code><td>改成 <code class="language-plaintext highlighter-rouge">find_or_create_by(...)</code></table><li>注意！ <code class="language-plaintext highlighter-rouge">where(...)</code> 返回 relation，而不像旧式 Finder 方法会返回阵列，需要返回阵列请用 <code class="language-plaintext highlighter-rouge">to_a</code>。<li>注意！这些对应的方法，不会与先前的 Finder 方法，生成出相同的 SQL 语句。<li>要重新启用旧式的 Finder 方法，可以使用 <a href="https://github.com/rails/activerecord-deprecated_finders">activerecord-deprecated_finders gem</a>。</ul><h4 id="24-active-resource">2.4 Active Resource</h4><p>Rails 4.0 将 Active Resource 抽成独立的 Gem。若你仍需要此功能，将 <a href="https://github.com/rails/activeresource">Active Resource gem</a> 加到 Gemfile。<h4 id="25-active-model">2.5 Active Model</h4><ul><li>Rails 4.0 更改了 <code class="language-plaintext highlighter-rouge">ActiveModel::Validations::ConfirmationValidator</code> 错误附加的方式。以前 confirmation 验证错误发生时，错误会加到 <code class="language-plaintext highlighter-rouge">attribute</code> 上，现在则会附加到 <code class="language-plaintext highlighter-rouge">:#{attribute}_confirmation</code>。<li>Rails 4.0 将 <code class="language-plaintext highlighter-rouge">ActiveModel::Serializers::JSON.include_root_in_json</code> 的缺省值改为 <code class="language-plaintext highlighter-rouge">false</code>，现在 Active Model Serializers 与 Active Record 对象缺省有著相同的行为。这表示你可以移除或注解掉这一行：</ul><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># config/initializers/wrap_parameters.rb</span>

  <span class="c1"># Disable root element in JSON by default.</span>
  <span class="c1"># ActiveSupport.on_load(:active_record) do</span>
  <span class="c1">#   self.include_root_in_json = false</span>
  <span class="c1"># end</span></code></pre></figure><h4 id="26-action-pack">2.6 Action Pack</h4><ul><li>Rails 4.0 引入了 <code class="language-plaintext highlighter-rouge">ActiveSupport::KeyGenerator</code>，用来生成及检查已签署的 cookie。请在 <code class="language-plaintext highlighter-rouge">config/initializers/secret_token.rb</code> 加入新的 <code class="language-plaintext highlighter-rouge">secret_key_base</code>：</ul><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># config/initializers/secret_token.rb</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_token</span> <span class="o">=</span> <span class="s1">'existing secret token'</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_key_base</span> <span class="o">=</span> <span class="s1">'new secret key base'</span></code></pre></figure><p>请注意！要等到使用者都使用你的 Rails 4.x app，并确保你不会降级到 Rails 3.x，才设置 <code class="language-plaintext highlighter-rouge">secret_key_base</code>。因为 cookie 签署的算法并不向下相容。忽略 deprecation warning 使用 <code class="language-plaintext highlighter-rouge">secret_token</code> 也是没问题的，只要你知道你自己在做什么就好。<br /> 如果有外部应用程序或是 JavaScript，需要能够读 Rails app 签署的 session cookies，在你还没有解决这些问题之前，不要设置 <code class="language-plaintext highlighter-rouge">secret_key_base</code>。<ul><li>有设置 <code class="language-plaintext highlighter-rouge">secret_key_base</code> 的话，Rails 4.0 会加密以 cookie-based session 的内容。Rails 3.x 有签署，但未加密。签署的 cookie 是安全的，因为他们是经由你的 app 生成与签署。然而 cookie 的内容仍可被使用者看到，因此加密内容排除了此风险，且没有降低多少的效能。请阅读 <a href="https://github.com/rails/rails/pull/9978">Pull Request #9978</a> 来了解更多有关 session cookie 加密的细节。<li>Rails 4.0 移除了 <code class="language-plaintext highlighter-rouge">ActionController::Base.asset_path</code> 选项。请使用 Assets Pipeline。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActionController::Base.page_cache_extension</code> 选项。请使用 <code class="language-plaintext highlighter-rouge">ActionController::Base.default_static_extension</code> 来取代。<li>Rails 4.0 从 Action Pack 移除了 Action 与 Page 的 Cache。若要使用 <code class="language-plaintext highlighter-rouge">caches_action</code>、<code class="language-plaintext highlighter-rouge">caches_pages</code> 请加入 <a href="https://github.com/rails/actionpack-action_caching">actionpack-action_caching</a> gem。<li>Rails 4.0 移除了 XML 参数解析器。若要使用请加入 <a href="https://github.com/rails/actionpack-xml_parser">actionpack-xml_parser</a>。<li>Rails 4.0 更改了缺省的 memcached 用户端，从 <a href="https://github.com/mperham/memcache-client">memcache-client</a> 换成了 <a href="https://github.com/mperham/dalli">dalli</a>，升级只需加入 <code class="language-plaintext highlighter-rouge">gem 'dalli'</code> 至 <code class="language-plaintext highlighter-rouge">Gemfile</code>。<li>Rails 4.0 弃用了 Controller 的 <code class="language-plaintext highlighter-rouge">dom_id</code> 与 <code class="language-plaintext highlighter-rouge">dom_class</code> 方法（View 依然能用）。要用的话请在 Controller <code class="language-plaintext highlighter-rouge">include</code> <code class="language-plaintext highlighter-rouge">ActionView::RecordIdentifier</code>。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">link_to</code> 的 <code class="language-plaintext highlighter-rouge">:confirm</code> 选项，应改写为 <code class="language-plaintext highlighter-rouge">data: { confirm: 'Are you sure?' }</code>，<code class="language-plaintext highlighter-rouge">link_to_if</code>、<code class="language-plaintext highlighter-rouge">link_to_unless</code> 同样受影响。<li>Rails 4.0 修改了 <code class="language-plaintext highlighter-rouge">assert_generates</code>、<code class="language-plaintext highlighter-rouge">assert_recognizes</code> 以及 <code class="language-plaintext highlighter-rouge">assert_routing 的工作方式。这些 assertions 会抛出 </code>Assertion<code class="language-plaintext highlighter-rouge"> 而不是 </code>ActionController::RoutingError` 错误。<li>在 Rails 4.0，如果定义了重复名称的路由时，会抛出 <code class="language-plaintext highlighter-rouge">ArgumentError</code>。请见下面两例（重复的 <code class="language-plaintext highlighter-rouge">example_path</code>）：</ul><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">get</span> <span class="s1">'one'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
  <span class="n">get</span> <span class="s1">'two'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
  
  <span class="n">resources</span> <span class="ss">:examples</span>
  <span class="n">get</span> <span class="s1">'clashing/:id'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span></code></pre></figure><p>第一个例子可直接换名字来解决。第二个例子可使用 <code class="language-plaintext highlighter-rouge">resources</code> 方法提供的 <code class="language-plaintext highlighter-rouge">only</code> 与 <code class="language-plaintext highlighter-rouge">except</code> 选项来限制生成出的路由，详见 <a href="/guides/edge-translation/routing-zh_TW.md#restricting-the-routes-created">Routing Guide</a><ul><li>Rails 4.0 更改了 route 有 unicode 字符的生成方式。现在 route 里可直接使用 unicode 字符，先前需要 <code class="language-plaintext highlighter-rouge">escape</code> 的作法不再需要了：</ul><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">get</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="s1">'こんにちは'</span><span class="p">),</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span></code></pre></figure><p>改为<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">get</span> <span class="s1">'こんにちは'</span><span class="p">,</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span></code></pre></figure><ul><li>Rails 4.0 要求使用 <code class="language-plaintext highlighter-rouge">match</code> 的 route 必须指定 HTTP 动词:</ul><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># Rails 3.x</span>
    <span class="n">match</span> <span class="s2">"/"</span> <span class="o">=&gt;</span> <span class="s2">"root#index"</span>

  <span class="c1"># 改成</span>
    <span class="n">match</span> <span class="s2">"/"</span> <span class="o">=&gt;</span> <span class="s2">"root#index"</span><span class="p">,</span> <span class="ss">via: :get</span>

  <span class="c1"># 或</span>
    <span class="n">get</span> <span class="s2">"/"</span> <span class="o">=&gt;</span> <span class="s2">"root#index"</span></code></pre></figure><ul><li><p>Rails 4.0 移除了 <code class="language-plaintext highlighter-rouge">ActionDispatch::BestStandardsSupport</code> 中间件。因为 <code class="language-plaintext highlighter-rouge">&lt;!DOCTYPE html&gt;</code> 如<a href="http://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx">此文</a>所述，已触发了标准模式。而 ChromeFrame header 被移到 <code class="language-plaintext highlighter-rouge">config.action_dispatch.default_headers</code> 了。<p>记得移除所有使用到 <code class="language-plaintext highlighter-rouge">ActionDispatch::BestStandardsSupport</code> middleware 的参照：</ul><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># 会抛出异常</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span><span class="p">(</span><span class="no">Rack</span><span class="o">::</span><span class="no">Lock</span><span class="p">,</span>       <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">BestStandardsSupport</span><span class="p">)</span></code></pre></figure><p>并移除环境设置中的 <code class="language-plaintext highlighter-rouge">config.action_dispatch.best_standards_support</code>。<ul><li>Rails 4.0 预编译不再自动从 <code class="language-plaintext highlighter-rouge">vendor/assets</code> 与 <code class="language-plaintext highlighter-rouge">lib/assets</code> 拷贝非 JS 或 CSS 的 assets。Rails 应用程序与 Engine 的开发者应将这些 assets 移到 <code class="language-plaintext highlighter-rouge">app/assets</code> 或设置 <code class="language-plaintext highlighter-rouge">config.assets.precompile</code>。<li>Rails 4.0 当 action 不知道如何处理 request 格式时会抛出 <code class="language-plaintext highlighter-rouge">ActionController::UnknownFormat</code> 异常。缺省是 406 Not Acceptable，但你可以改成别的 status code，在 Rails 3 只能是 406。<li>Rails 4.0 当 <code class="language-plaintext highlighter-rouge">ParamsParser</code> 无法解析 request params 时，会抛出通用的 <code class="language-plaintext highlighter-rouge">ActionDispatch::ParamsParser::ParseError</code> 异常。你可以 <code class="language-plaintext highlighter-rouge">rescue</code> 这个异常，而不是较为底层的 <code class="language-plaintext highlighter-rouge">MultiJson::DecodeError</code>。<li>Rails 4.0，当 Engine 安装到有 URL 前缀的宿主（hosting application）时，<code class="language-plaintext highlighter-rouge">SCRIPT_NAME</code> 已经将 URL 前缀适当地设置好了。不再需要设置 <code class="language-plaintext highlighter-rouge">default_url_options[:script_name]</code> 来覆写 URL 前缀。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActionController::Integration</code> 请使用 <code class="language-plaintext highlighter-rouge">ActionDispatch::Integration</code>。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActionController::IntegrationTest</code> 请使用 <code class="language-plaintext highlighter-rouge">ActionDispatch::IntegrationTest</code>。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActionController::PerformanceTest</code> 请使用 <code class="language-plaintext highlighter-rouge">ActionDispatch::PerformanceTest</code>。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActionController::AbstractRequest</code> 请使用 <code class="language-plaintext highlighter-rouge">ActionDispatch::Request</code>。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActionController::Request</code> 请使用 <code class="language-plaintext highlighter-rouge">ActionDispatch::Request</code>。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActionController::AbstractResponse</code> 请使用 <code class="language-plaintext highlighter-rouge">ActionDispatch::Response</code>。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActionController::Response</code> 请使用 <code class="language-plaintext highlighter-rouge">ActionDispatch::Response</code>。<li>Rails 4.0 弃用了 <code class="language-plaintext highlighter-rouge">ActionController::Routing</code> 请使用 <code class="language-plaintext highlighter-rouge">ActionDispatch::Routing</code>。</ul><h4 id="27-active-support">2.7 Active Support</h4><p>Rails 4.0 移除了 <code class="language-plaintext highlighter-rouge">ERB::Util#json_escape</code> 的 <code class="language-plaintext highlighter-rouge">j</code> 别名。因为 <code class="language-plaintext highlighter-rouge">j</code> 已经被 <code class="language-plaintext highlighter-rouge">ActionView::Helpers::JavaScriptHelper#escape_javascript</code> 所使用。<h4 id="28-helpers-加载顺序">2.8 Helpers 加载顺序</h4><p>Rails 4.0 更改了 Helpers 的加载顺序。之前是将各目录的 Helpers 集合起来，并按字母排序加载。Rails 4.0 之后，Helpers 会按照目录原本加载的顺序，并在各自的目录里按字母依序加载。除非你特别使用了 <code class="language-plaintext highlighter-rouge">helpers_path</code> 参数，否则这个改动只会影响到从 Engine 加载 Helpers 的顺序。如果你正依赖加载的顺序，可以检查升级后这些 Helper 是否正常工作。如果想更改 Engine 加载的顺序，可以使用 <code class="language-plaintext highlighter-rouge">config.railties_order=</code> 方法。<h4 id="29-active-record-observer-与-action-controller-sweeper">2.9 Active Record Observer 与 Action Controller Sweeper</h4><p>Active Record Observer 与 Action Controller Sweeper 被抽成独立的 Gem：<a href="https://github.com/rails/rails-observers">rails-observers</a>。<h4 id="210-sprockets-rails">2.10 sprockets-rails</h4><ul><li><code class="language-plaintext highlighter-rouge">assets:precompile:primary</code> 被移除了。请改用 <code class="language-plaintext highlighter-rouge">assets:precompile</code>。<li><code class="language-plaintext highlighter-rouge">config.assets.compress</code> 选项应改成 <code class="language-plaintext highlighter-rouge">config.assets.js_compressor</code>：<li>config.assets.js_compressor = :uglifier</ul><h4 id="211-sass-rails">2.11 sass-rails</h4><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">asset</span><span class="o">-</span><span class="n">url</span><span class="p">(</span><span class="s2">"rails.png"</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
  <span class="c1"># 改成</span>
  <span class="n">asset</span><span class="o">-</span><span class="n">url</span><span class="p">(</span><span class="s2">"rails.png"</span><span class="p">)</span></code></pre></figure><p><em>from</em>: <a href="https://github.com/JuanitoFatas/Guides/blob/master/guides/edge-translation/upgrading-ruby-on-rails-zh_CN.md">JuanitoFatas</a></article><hr class="dingbat related mb6" /><aside class="comments related" role="complementary"><h2 class="hr-bottom">Comments</h2><script src="https://giscus.app/client.js" data-repo=hjijin/hjijin.github.io data-repo-id=MDEwOlJlcG9zaXRvcnk3NDk1MTc3 data-category=General data-category-id=DIC_kwDOAHJeCc4CVYjO data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=light data-lang=zh-CN crossorigin=anonymous async> </script></aside><footer class="content" role="contentinfo"><hr/><p><small class="copyright">© 2023 Jim Huang. All rights reserved. </small><nav class="legal"><small> <a class="heading flip-title" href="/blog/licenses/">LICENSES</a> </small></nav><hr class="sr-only"/></footer></main><hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(25,55,71);background-image:url(/blog/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky no-fouc"><div class="sidebar-about"> <a class="no-hover" href="/blog/" tabindex="-1"> <img src="/blog/assets/img/mynameis007.png" class="avatar" alt="Jim.h' Blog" width="120" height="120" loading="lazy" /> </a> <a class="sidebar-title" href="/blog/"><h2 class="h1">Jim.h' Blog</h2></a><p class=""><p>阅读代码比编写代码更难</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <input type="checkbox" id="folder-checkbox-9" /><div class="list-wrapper"> <a href="/blog/development/" class="sidebar-nav-item" >技术</a> <button class="spread-btn" onclick="javascript:spread(9)"> <label id="spread-icon-9" class="material-icons">arrow_right</label> </button></div><ul class="list-body"><li> <a class="sidebar-nav-subitem" href="/blog/tag-client/">前端/移动</a><li> <a class="sidebar-nav-subitem" href="/blog/tag-server/">后端/架构</a><li> <a class="sidebar-nav-subitem" href="/blog/tag-database/">数据库</a><li> <a class="sidebar-nav-subitem" href="/blog/tag-solved-problems/">解决的问题</a></ul><li> <input type="checkbox" id="folder-checkbox-10" /><div class="list-wrapper"> <a href="/blog/daily/" class="sidebar-nav-item" >随笔</a> <button class="spread-btn" onclick="javascript:spread(10)"> <label id="spread-icon-10" class="material-icons">arrow_right</label> </button></div><ul class="list-body"><li> <a class="sidebar-nav-subitem" href="/blog/tag-arts-and-photography/">艺术与摄影</a></ul><li> <input type="checkbox" id="folder-checkbox-11" /><div class="list-wrapper"> <a href="/blog/books/" class="sidebar-nav-item" >读书</a> <button class="spread-btn" onclick="javascript:spread(11)"> <label id="spread-icon-11" class="material-icons">arrow_right</label> </button></div><ul class="list-body"><li> <a class="sidebar-nav-subitem" href="/blog/tag-tech/">科技 IT</a><li> <a class="sidebar-nav-subitem" href="/blog/tag-science-and-math/">科学与自然</a><li> <a class="sidebar-nav-subitem" href="/blog/tag-business-and-money/">经济管理</a><li> <a class="sidebar-nav-subitem" href="/blog/tag-history/">历史</a></ul><li><div class="list-wrapper"> <a href="/blog/resume/" class="sidebar-nav-item" >简历</a></div><li><div class="list-wrapper"> <a href="/blog/tags/" class="sidebar-nav-item" >分类</a></div></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://github.com/hjijin" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a><li> <a href="mailto:hjijin.gz@gmail.com" title="Email" class="no-mark-external"> <span class="icon-mail"></span> <span class="sr-only">Email</span> </a><li> <a href="https://instagram.com/hjijin.gz" title="Instagram" class="no-mark-external"> <span class="icon-instagram"></span> <span class="sr-only">Instagram</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}(); </script> <script src="/blog/assets/js/hydejack-9.1.6.js" type="module"></script> <script src="/blog/assets/js/LEGACY-hydejack-9.1.6.js" nomodule defer></script> <script src="/assets/js/sidebar-folder.js"></script> <script src="/assets/js/clap-button.js"></script> <script> document .getElementById("_pushState") .addEventListener("hy-push-state-load", function () { get_clap_count(); apply_lightbox(); }); </script> <script type="module"> if ('serviceWorker' in navigator) { /**/ navigator.serviceWorker.getRegistration() .then(r => r.unregister()) .catch(() => {}); /**/ } </script><div hidden><h2 class="sr-only">Templates (for web app):</h2><template id="_animation-template"><div class="animation-main fixed-top"><nav id="breadcrumbs" class="screen-only"><ul></ul></nav><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template"><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template"><div class="page"><h2 class="page-title">Error</h2><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template> <template id="_dark-mode-template"> <button id="_dark-mode" class="nav-btn no-hover" > <span class="sr-only">Dark Mode</span> <span class="icon-brightness-contrast"></span> </button> </template></div></html>
